# EV-FFT (MATLAB)
**Pixel-wise FFT analysis of time-lapse microscopy (ND2/TIFF) to visualize EV/exosome temporal-frequency signatures**

## Authors / Contribution
This repository supports a research project/paper contributed by **Hyo Geun Yun** and **Kang Jisoo**.

## Affiliation / Tag
**HYU-Seoul-Biomedical-Electronic-Engineering-mneLAB-2026**

This repository provides a MATLAB Live Script pipeline that:
1) exports ND2 → TIFF time series (optional),  
2) builds **per-pixel one-sided FFT amplitude stacks**,  
3) aggregates results across experiments, and  
4) generates **low-frequency energy (RSS) maps** and other analysis outputs (ROI normalization, cutoff-iFFT reconstruction, similarity metrics).

> All scripts are provided as **.mlx (MATLAB Live Scripts)** for interactive use.  
> If you prefer plain scripts/functions, you can convert via MATLAB: **Live Editor → Export → MATLAB Code (.m)**.

---

## Why EV-FFT?
Time-lapse EV/exosome imaging often produces subtle, temporally varying intensity patterns that are hard to capture with single-frame features.  
EV-FFT converts each pixel’s time-series into a frequency representation, enabling:
- **frequency-resolved maps** (which frequencies dominate where),
- **low-frequency energy maps** (robust signal visualization),
- and optional **frequency-cutoff reconstruction** (iFFT with selected bins).

---

## Repository Contents

| Script | What it does | Main outputs |
|---|---|---|
| `00_nd2_tiff_export.mlx` | Export ND2 movies into per-frame TIFFs using Bio-Formats (`bfmatlab`). | TIFF time-series folders |
| `01_kjs_fft_whole_240327.mlx` | Read TIFF time-series, optionally downsample time axis, compute **per-pixel FFT amplitude spectrum** (one-sided), and save stacks. | `*_exosome_frequency_stack.mat` |
| `02_kjs_fft_load_240327.mlx` | Batch-load all saved FFT stacks into a structured variable for downstream analysis. | `exosomeData` struct |
| `03_ver2_kjs_fft_ImageProcessing_251116.mlx` | Analysis/post-processing: low-frequency RSS maps, global normalization, ROI cropping, cutoff-iFFT reconstruction, and metrics (e.g., Frechet distance). | Figures + derived maps/metrics |

---

## Requirements
- MATLAB (Live Scripts supported)
- **Image Processing Toolbox** (recommended)
- **Parallel Computing Toolbox** (optional; speeds up `parfor`)
- **Bio-Formats bfmatlab** (required only for ND2 export in `00_nd2_tiff_export.mlx`)

---

## Recommended Folder Layout

EV-FFT/
00_nd2_tiff_export.mlx
01_kjs_fft_whole_240327.mlx
02_kjs_fft_load_240327.mlx
03_ver2_kjs_fft_ImageProcessing_251116.mlx
README.md

raw_nd2/ (optional)
sampleA.nd2
sampleB.nd2

sampleA/ (generated by export or prepared manually)
sampleA_T0001.tif
sampleA_T0002.tif
...
sampleB/
sampleB_T0001.tif
...


---

## Data Assumptions (Important)
- Input time series is assumed to be acquired at ~**40 Hz** (used internally for `Fs`).
- TIFF sequences are assumed to represent **one channel** time series per folder (unless you adapt the scripts).
- Output stacks can be very large (H×W×F bins). Make sure you have enough RAM and disk space.

---

## Pipeline Overview

### Step 0 — Prepare TIFF Time Series
You have two options:
- **Option A:** Start from ND2 and run `00_nd2_tiff_export.mlx`
- **Option B:** If you already have TIFF sequences, place them into per-sample folders

**Naming recommendation:** `sampleName_T0001.tif`, `sampleName_T0002.tif`, ...

---

### Step 1 — (Optional) ND2 → TIFF Export (`00_nd2_tiff_export.mlx`)
1. Install Bio-Formats **bfmatlab**
2. Update `addpath(...)` inside the script to point to your local bfmatlab folder
3. Run the script

**Output:** One folder per ND2 file, containing frame TIFFs.

**Troubleshooting tips**
- If MATLAB cannot find `bfopen`, your bfmatlab path is not set correctly.
- If ND2 contains multiple series/channels, you may need to select the correct series in the script.

---

### Step 2 — Build FFT Amplitude Stacks (`01_kjs_fft_whole_240327.mlx`)
This is the main compute step.

**What it does**
- Finds sample folders (each containing TIFF time series)
- Reads frames into a time stack `I(y,x,t)`
- Optionally downsamples in time using `Sr`
- Computes FFT for each pixel’s time-series
- Stores **one-sided amplitude spectrum** per pixel:
  - `A(y,x,k)` for frequency bin `k`
- Saves result as a 3D stack

**Key parameters (typical)**
- `Sr` : time downsampling factor  
  - Example: `Sr=1` uses all frames; `Sr=3` uses every 3rd frame
- `Fs = round(40/Sr)` : effective sampling rate (Hz) assuming original 40 Hz

**Output (per sample folder)**
- `sampleName_exosome_frequency_stack.mat` (saved with `-v7.3`)
- variable: `exosome_frequency_stack`
- shape: **[height × width × nFreqBins]**

> Note: One-sided spectrum typically includes DC and positive frequencies.

**Performance tips**
- Large images + long time series can be heavy.
- Use `parfor` (Parallel Computing Toolbox) to speed up per-pixel computation.
- Ensure your disk has enough space for `-v7.3` MAT files.

---

### Step 3 — Load Multiple Results (`02_kjs_fft_load_240327.mlx`)
This script helps organize many experiments.

**What it does**
- Searches for `*_exosome_frequency_stack.mat`
- Loads each into a structure, e.g.:
  - `exosomeData.<fieldName> = exosome_frequency_stack;`

**Output**
- A single workspace struct `exosomeData` containing multiple stacks.

**Tip**
- If field names become messy, you can implement a cleaner naming convention in this loader.

---

### Step 4 — Post-processing / Analysis (`03_ver2_kjs_fft_ImageProcessing_251116.mlx`)
This script is analysis-oriented and contains multiple sections you can run selectively.

#### 4.1 Low-frequency energy (RSS) map
A common EV-FFT visualization is a **low-frequency energy map** per pixel:

- Exclude DC bin (index 1)
- Sum energy of low-frequency bins (2 to n+1)
- Take square root (RSS)

Example concept:
\[
E(y,x) = \sqrt{\sum_{k=2}^{n+1} A(y,x,k)^2}
\]

**Why RSS?**  
It provides a robust scalar measure of “how much low-frequency activity” exists at each pixel.

#### 4.2 Global normalization + ROI cropping
- Normalize to a global scale for comparisons
- Crop a fixed ROI to focus on region of interest
- Typical parameters:
  - `x_center`, `y_center`
  - `roi_size = [w, h]`

#### 4.3 Frequency cutoff + iFFT reconstruction (optional)
- Keep only selected frequency bins (e.g., low-pass / band-pass)
- Reconstruct time-domain signal using iFFT
- Useful to visualize how selected frequencies contribute to dynamics

#### 4.4 Metrics (optional)
- Some sections compute similarity/distance measures (e.g., Frechet distance)
- Useful for comparing signals across conditions

---

## Outputs You Should Expect

### Core output
- `*_exosome_frequency_stack.mat`
  - contains `exosome_frequency_stack(y,x,f)`

### Typical derived outputs (from analysis)
- `E_map` (low-frequency RSS energy map)
- Cropped/normalized maps
- Reconstructed time-series (after frequency cutoff)
- Optional statistics/metrics tables or figures

---

## Practical Guidance (Recommended Defaults)
- Start simple:
  - run `01` with a moderate `Sr` (e.g., 3–10) to test pipeline speed and output size
  - verify FFT stack dimensions and basic map quality
- Then refine:
  - adjust `Sr` and low-frequency bin range (`n`) based on your signal dynamics
  - lock ROI coordinates for consistent comparisons across samples

---

## Large Files & GitHub
Raw movies and derived stacks can be huge. Recommended approach:
- Keep code in GitHub
- Exclude data and large MAT files (or use Git LFS)

Suggested `.gitignore`:
```gitignore
# raw data
*.nd2
*.tif
*.tiff

# derived large outputs
*.mat

# MATLAB autosave
*.asv



